<!doctype html>
<html>
<head>
<title>Open Government</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="generator" content="Polymer Starter Kit" />
    <meta charset="utf-8">
  <!-- build:js bower_components/webcomponentsjs/webcomponents-lite.min.js -->
  <script src="bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  <!-- endbuild -->

  <!-- will be replaced with elements/elements.vulcanized.html -->
  <link rel="import" href="elements/elements.html">
  <!-- endreplace-->

</head>
<body class="fullbleed layout vertical">
<script>
    (function (document) {
        'use strict';

        var app = document.querySelector('#app');

        window.addEventListener('WebComponentsReady', function() {
            var ironAjax = document.querySelector('iron-ajax');
            ironAjax.addEventListener('response', function(e) {
                if (this.params.pageIdx === 1){
                    document.querySelector("#SearchResult2").innerHTML='';
                }
                if ( document.querySelector('#pending') != null
                    && ironAjax.activeRequests != null){
                    document.querySelector('#pending').innerHTML=
                    ironAjax.activeRequests.length  + ' progress: ('+ 
                    (this.lastResponse.response.metadata.totalresults
                    -ironAjax.activeRequests.length)  + ' of ' + 
                    this.lastResponse.response.metadata.totalresults + ') ';
                }

                if( e.detail.response != null){

                var document_body = document.querySelector("#SearchResult2");
                    if(true && document_body != null){ 
                    document_body.appendChild( document.createElement("hr")); 
                    var div=document.createElement("div"); 
                    div.innerHTML='<b><a href="'+e.detail.xhr.responseURL+'">'+
                    e.detail.xhr.responseURL+'</a></b>';
                    //document_body.appendChild( div ); 
                    }
                for(var i=0; i < e.detail.response.response.results.length; i++){
                    if(true && document_body != null){ 
                    var div=document.createElement("div"); 
                    var fulltext='';
                    var title='';
                    var sponsor='';
                    var active=false;
                    var actions='';
                    var actclause='';
                    if(e.detail.response.response.results[i].otype==='bill'){
                    //console.log( e.detail.response.response.results[i].data); 
                    fulltext= e.detail.response.response.results[i].data.bill.fulltext;
                    title= e.detail.response.response.results[i].data.bill.title;
                    sponsor= JSON.stringify(e.detail.response.response.results[i].data.bill.sponsor);
                    active = e.detail.response.response.results[i].data.bill.active;

                    actions= JSON.stringify(e.detail.response.response.results[i].data.bill.actions);
                    actions='';
                    for(var j=0; j < e.detail.response.response.results[i].data.bill.actions.length; j++){
                    actions += 
                     //JSON.stringify(e.detail.response.response.results[i].data.bill.actions[j]);
                     '<br>' +new Date(parseInt(e.detail.response.response.results[i].data.bill.actions[j].date)) +
                     ' ' + e.detail.response.response.results[i].data.bill.actions[j].text 
                     ;
                    }


                    actclause = e.detail.response.response.results[i].data.bill.actClause;
                    } else {
                    title = 'other: ' + e.detail.response.response.results[i].otype;
                    }
                    div.innerHTML='<br>'+
                    '<paper-header-panel class="flex"><div class="paper-header">' +
                    '<b>Title:</b>&nbsp;' + title + '<br>'+
                    '<b>Sponsor(s):</b>&nbsp;' + sponsor + '<br>' +
                    '<b>Action(s):</b>&nbsp;' + actions + '<br>' +
                    '<b>Active:</b>&nbsp;' + active + '<br>' +
                    '<b>Act Clause:</b>&nbsp;' + actclause + '<br>' +
                    '<b>Link:</b>&nbsp;<a href="' + e.detail.response.response.results[i].url + '">' +
                     e.detail.response.response.results[i].url + '</a><br>' +
                    '</div></paper-header-panel>' + 
                    '<paper-material evalation="2">' + fulltext + '</paper-material>'
                    ;
                    document_body.appendChild( div ); 

                    }
                }
                }

                if (this.params.pageIdx === 1){
                while (++this.params.pageIdx <= this.lastResponse.response.metadata.totalresults){
ironAjax.generateRequest();
                }
                }
            });
            //ironAjax.generateRequest();
        });

    })(document);

</script>


  <template is="dom-bind" id="app">
    <opengov-ny></opengov-ny>

    <paper-toast id="caching-complete"
                 duration="6000"
                 text="Caching complete! This app will work offline.">
    </paper-toast>

    <platinum-sw-register auto-register
                          clients-claim
                          skip-waiting
                          on-service-worker-installed="displayInstalledToast">
      <platinum-sw-cache default-cache-strategy="fastest"
                         precache-file="precache.json">
      </platinum-sw-cache>
    </platinum-sw-register>
  </template>

    <dom-module id="opengov-ny">
      <template>

<template is="dom-if" if="{{loading}}">
<!-- <paper-progress value="10" indeterminate="true" style="width:100%;"></paper-progress> -->
<paper-spinner active id="spinner"></paper-spinner>
</template> 


        <paper-input 
          label="Search?"
          value="{{term}}"></paper-input>

<!--
        <paper-input 
          label="Index?"
          value="{{pageIdx}}"></paper-input>
-->

        <br>

        <div style="text-align:center; padding:10px;">
          <paper-button tabindex="0" raised="true" style="background-color: lightblue;" on-click="searchPractice">Search</paper-button>
        </div>

        <iron-ajax id="OpenGovSearch"
             url="https://origin-proxy.appspot.com/open.nysenate.gov/legislation/2.0/search.jsonp"
                   params="{{ajaxParams}}"
                   handle-as="json"
                   last-response="{{data}}"
                   loading="{{loading}}"
                   activeRequests="{{active}}"
                   on-error="handleError">

        </iron-ajax>

        <br><br>
        <!-- Parameters: <b>{{stringify(ajaxParams)}}</b> -->

           <template is="dom-if" if="{{loading}}">
           <div>
                pending:<span id="pending"></span>
           </div>
          <template is="dom-repeat" items="{{data.response.results}}">
            <p><span>{{item.otype}}</span> 
            <span>{{item.oid}}</span> 
            <div><a href="{{item.url}}">{{item.url}}</a></div>
            <paper-material elevation="1">
            </paper-material>
            </p>
          </template>
           </template>

           <template is="dom-if" if="{{data.response.metadata.totalresults}}">
           <div>
                <b>total results available: </b><span>{{data.response.metadata.totalresults}}</span>
           </div>
           </template>

        <div id="SearchResult">
        </div>
        <div id="SearchResult2">
        </div>

      </template>
      <script>
      HTMLImports.whenReady(function () {
        Polymer({

          is: "opengov-ny",

          properties: {
            pageIdx: { type:Number, value:1 },
            url: {
                type:String
                //,
                //default: "https://origin-proxy.appspot.com/open.nysenate.gov/legislation/2.0/search.jsonp?pageSize=1&pageIdx=1&sort=modified&sortOrder=true&term=test%20-otype%3Atranscript&callback=a"
                },
            ajaxParams: {
              type: String,
              computed: 'buildSearchRequest(pageIdx,term)'
            }
          },

          stringify: JSON.stringify, 

          buildSearchRequest: function (pageIdx,term) {
            //document.querySelector("#SearchResult").innerHTML='';
            return {
              //Command: 'Search',
              //Criteria: searchCriterion,
              pageIdx: parseInt(pageIdx),
              pageSize: '1',
              sort:'modified',
              sortOrder:true,
              term: term,
              //term:'test -otype:transcript',
              callback:'a'
            };
          },

          searchPractice: function () {
            this.$.OpenGovSearch.generateRequest();
          },

          ajaxResponse: function(e, request) {
            var headers = request.xhr.getAllResponseHeaders();
            },

          handleError: function(e) {
            alert('Whoops! ' + e.detail);
          }

        });
        });
      </script>
  </dom-module>

  <!-- build:js scripts/app.js -->
  <script src="scripts/app.js"></script>
  <!-- endbuild-->
</body>
</html>
